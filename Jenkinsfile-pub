pipeline {
    
    agent {
        node {
            label 'jenkins-agent-1'
        }
    }
    
    environment {
    AWS_ACCOUNT_ID      = "public.ecr.aws/t9x8t6s4"
    AWS_DEFAULT_REGION  = "us-east-1"
    IMAGE_REPO_NAME     = "kandula-pub"
    IMAGE_TAG           = "latest"
    REPOSITORY_URI      = "${AWS_ACCOUNT_ID}/${IMAGE_REPO_NAME}"
    REPO_URL            = "https://github.com/opsschool-project/kandula-app-k8s.git"
    REPO_DIR            = "kandula-app-k8s"
    PYTHON_APP_IMAGE    = "python:3.9-slim"
    }
    
    stages {
        
        stage('Cloning Git') {
            steps {
                git url: "${REPO_URL}", branch: 'main',
                 credentialsId: 'Github_token'
            }
        }
        
        stage('Logging into AWS ECR') {
            steps {
                script {
                    sh "aws ecr-public get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}"
                
                }
             }
        }
           
        stage ('Restart docker') {
             steps {
                 sh 'sudo service docker restart'
          }
        }
        
        stage('Building image') {
            steps{
                script {
                    dockerImage = docker.build "${IMAGE_REPO_NAME}:${IMAGE_TAG}"
                }
            }
        }
        
        stage('Pushing to ECR') {
            steps{
                script {
                    sh "docker tag ${IMAGE_REPO_NAME}:${IMAGE_TAG} ${REPOSITORY_URI}:${IMAGE_TAG}"
                    sh "docker push ${REPOSITORY_URI}:${IMAGE_TAG}"
                }
            }
        }
                      
        stage ('Delete the docker images') {
             steps {
                 sh "docker rmi -f ${PYTHON_APP_IMAGE}"
                 sh "docker rmi -f ${REPOSITORY_URI}"
                 sh "docker rmi -f ${IMAGE_REPO_NAME}:${IMAGE_TAG}"
          }
        }
                
//         stage ('Delete the folder and the files that has copied from the cloned repo using Dockerfile') {
//              steps {
//                  sh "rm -rf /home/ec2-user/jenkins-agent/jenkins-agent/workspace/kandula"
//                  sh "rm -rf /home/ec2-user/jenkins-agent/jenkins-agent/workspace/kandula@tmp"
//           }
//         }
        
        stage ('Delete the cloned repo') {
             steps {
                 sh "rm -rf ${REPO_DIR}"
          }
        }
        
        stage ("Login to EKS") {
            steps {
                withKubeConfig(caCertificate: '', clusterName: '', contextName: '', credentialsId: 'eks.cred', namespace: '', serverUrl: '') {
                }
              }
            }
        
        stage ("Deploy to EKS") {
            steps {
                sh "kubectl apply -f kandula-app.yaml"
                }
              }        
        
        stage('Slack notification') {
            steps {
                script {
                    def status = currentBuild.currentResult // Get the result of the current build
                    def message = status == 'SUCCESS' ? "Build #${env.BUILD_NUMBER} succeeded!" : "Build #${env.BUILD_NUMBER} failed!"

                    try {
                        slackSend channel: 'jenkins-notifications', color: status == 'SUCCESS' ? '#36a64f' : '#ff0000', message: message, tokenCredentialId: 'slack.integration'
                    } catch (Exception e) {
                        echo "Slack notification failed with error: ${e.getMessage()}"
                    }
                }
            }
        }
        
    }
}
